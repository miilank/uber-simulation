<div class="h-full flex items-center justify-center bg-white">
    <div class="w-full max-w-md">
      @if (step() == 1) {
        <div class="flex flex-col items-center gap-4 p-6 md:p-7 bg-white">
            <h1 class="text-[28px] font-bold text-[#111111] leading-tight tracking-tight self-stretch">
                Book a ride
            </h1>
        <div class="w-full">
          <location-search-input
            hintMessage="Pickup spot"
            [inputClass]="'input-base'"
            [containerClass]="'w-full'"
            (selected)="onPickupSelected($event)"
            [value]="bookingState.pickup()?.formattedText"
          ></location-search-input>
        </div>
        @for (_ of bookingState.stops(); track $index) {
          <div class="w-full flex items-center gap-2">
            <div class="w-full">
              <location-search-input
                hintMessage="Stop"
                [inputClass]="'input-base'"
                [containerClass]="'w-full'"
                (selected)="onStopSelected($index, $event)"
                [value]="bookingState.stops()[$index]?.formattedText"
              ></location-search-input>
            </div>
              <button
                type="button"
                class="w-9 h-9 flex items-center justify-center rounded-full cursor-pointer"
                (click)="removeStop($index)"
              >
                <img
                  ngSrc="/icons/ic_trashcan.png"
                  alt=""
                  width="16"
                  height="16"
                  class="w-4 h-4"
                />
              </button>
            </div>
          }

        <button
          type="button"
          class="flex items-center justify-center gap-1 self-stretch py-2 hover:opacity-80 transition-opacity"
          (click)="addStop()"
        >
          <span class="text-[11px] text-black leading-none">Add a stop</span>
        </button>

        <div class="w-full">
          <location-search-input
            hintMessage="Where are you going?"
            [inputClass]="'input-base'"
            [containerClass]="'w-full'"
            (selected)="onDropoffSelected($event)"
            [value]="bookingState.dropoff()?.formattedText"
          ></location-search-input>
        </div>
        <div class="mt-2 self-stretch">
              <label class="text-xs text-gray-500">Do you want to schedule ahead?</label>
              <input
                  type="datetime-local"
                  class="input-base w-full"
                  name="scheduledAt"
                  [(ngModel)]="scheduledDate"
                  [min]="minDate"
                  [max]="maxDate"
                  step="60" 
              />
                <p class="text-red-400 text-xs">
                  @if (!isDateValid(scheduledDate())) { <span>Date is invalid.</span> }
                </p>
              <p class="text-xs mt-1">You can schedule up to 5 hours from now.</p>
        </div>

        <div class="w-full flex flex-col gap-2">
          <label class="text-xs text-gray-600">Fill from saved route</label>
          <div class="relative">
            <select
              class="w-full input-base"
              [(ngModel)]="selectedRoute"
              (ngModelChange)="setFromRoute($event)"
            >
              @for (r of favoriteRoutes(); track $index) {
                <option [ngValue]="r">{{ r.name }}</option>
              }
            </select>

            <svg class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
        

        <button (click)="nextStep()" class="w-full h-12 flex items-center px-4 cursor-pointer bg-app-accent rounded-full text-sm font-normal font-poppins text-neutral-900 hover:bg-lime-500 transition-colors">
            <span class="tracking-wide text-black flex-1 text-center">
                Next
            </span>

            <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
            >
                <g clip-path="url(#clip0_66_547)">
                <path
                    d="M10.0001 13.3334L13.3334 10.0001M13.3334 10.0001L10.0001 6.66675M13.3334 10.0001L6.66675 10.0001M18.3334 10.0001C18.3334 14.6025 14.6025 18.3334 10.0001 18.3334C5.39771 18.3334 1.66675 14.6025 1.66675 10.0001C1.66675 5.39771 5.39771 1.66675 10.0001 1.66675C14.6025 1.66675 18.3334 5.39771 18.3334 10.0001Z"
                    stroke="#1E1E1E"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                />
                </g>
                <defs>
                <clipPath id="clip0_66_547">
                    <rect width="20" height="20" fill="white" />
                </clipPath>
                </defs>
            </svg>
        </button>

        <button (click)="previousStep()" class="w-full cursor-pointer h-12 border-[1.5px] border-gray-300 rounded-full text-sm font-normal font-poppins text-gray-700 hover:bg-gray-50 transition-colors">
            Cancel
        </button>
    </div>
    }

      @if (step() == 2) {
        <div class="flex flex-col items-center gap-4 p-6 md:p-7 bg-white">
            <h1 class="text-[28px] font-bold text-[#111111] leading-tight tracking-tight self-stretch">
                Who is going?
            </h1>

          <div class="input-base w-full flex items-center">
            <img
              ngSrc="/defaultprofile.png"
              width="1"
              height="1"
              alt="Profile"
              class="w-6 h-6 md:w-10 md:h-10 rounded-full object-cover"
            />
            <span class="tracking-wide text-black flex-1 text-center">
                {{user().email}}
            </span>
          </div>

          <button
            type="button"
            class="flex items-center justify-center gap-1 self-stretch py-2 hover:opacity-80 transition-opacity"
            (click)="addPassenger()">
            <span class="cursor-pointer text-[11px] text-black leading-none">Add a passenger</span>
          </button>

            @for (_ of passengerEmails(); track $index) {
            <div class="w-full flex items-center gap-2">
              <div class="w-full">
                <input
                  class="input-base"
                  (blur)="addEmail($event, $index)"
                  [value]="passengerEmails()[$index]"
                 />
              </div>

                <button
                  type="button"
                  class="w-9 h-9 flex items-center justify-center rounded-full cursor-pointer"
                  (click)="removePassenger($index)"
                >
                  <img
                    ngSrc="/icons/ic_trashcan.png"
                    alt=""
                    width="16"
                    height="16"
                    class="w-4 h-4"
                  />
                </button>
            </div>
            }


            <button (click)="nextStep()" class="w-full h-12 flex items-center px-4 cursor-pointer bg-app-accent rounded-full text-sm font-normal font-poppins text-neutral-900 hover:bg-lime-500 transition-colors">
                <span class="tracking-wide text-black flex-1 text-center">
                    Next
                </span>

                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <g clip-path="url(#clip0_66_547)">
                    <path
                        d="M10.0001 13.3334L13.3334 10.0001M13.3334 10.0001L10.0001 6.66675M13.3334 10.0001L6.66675 10.0001M18.3334 10.0001C18.3334 14.6025 14.6025 18.3334 10.0001 18.3334C5.39771 18.3334 1.66675 14.6025 1.66675 10.0001C1.66675 5.39771 5.39771 1.66675 10.0001 1.66675C14.6025 1.66675 18.3334 5.39771 18.3334 10.0001Z"
                        stroke="#1E1E1E"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                    </g>
                    <defs>
                    <clipPath id="clip0_66_547">
                        <rect width="20" height="20" fill="white" />
                    </clipPath>
                    </defs>
                </svg>
            </button>

            <button (click)="previousStep()" class="w-full cursor-pointer h-12 border-[1.5px] border-gray-300 rounded-full text-sm font-normal font-poppins text-gray-700 hover:bg-gray-50 transition-colors">
                Back
            </button>
        </div>
      }

      @if (step() == 3) {
        <div class="flex flex-col items-center gap-4 p-6 md:p-7 bg-white">
            <h1 class="text-[28px] font-bold text-[#111111] leading-tight tracking-tight self-stretch">
                Any preferences?
            </h1>

          <button
            type="button"
            class="w-full flex items-center justify-between px-3 py-2 rounded-lg hover:opacity-80 transition-opacity"
            (click)="pets = !pets"
          >
            <div class="flex items-center gap-3">
              <span class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center border border-gray-300"
                    [ngClass]="{'bg-app-accent': pets, 'bg-white': !pets}">
                <!-- Check mark -->
                 @if(pets){
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="#111111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                }
              </span>

              <span class="tracking-wide text-black">Traveling with pets</span>
            </div>
          </button>

          <button
            type="button"
            class="w-full flex items-center justify-between px-3 py-2 rounded-lg hover:opacity-80 transition-opacity"
            (click)="infants = !infants"
          >
            <div class="flex items-center gap-3">
              <span class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center border border-gray-300"
                    [ngClass]="{'bg-app-accent': infants, 'bg-white': !infants}">
                <!-- Check mark -->
                 @if (infants) {
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="#111111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                }
              </span>

              <span class="tracking-wide text-black">Traveling with infants</span>
            </div>

          </button>

          <!-- Vehicle type -->
          <div class="w-full flex flex-col gap-2">
            <label class="text-xs text-gray-600">Vehicle type</label>
            <div class="relative">
              <select
                class="w-full input-base"
                [(ngModel)]="vehicleType"
              >
                <option [value]="'any'">Any</option>
                @for (v of vehicleTypes; track $index) {
                  <option>{{ v }}</option>
                }
                
              </select>

              <svg class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none" width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>

          <div class="my-8 flex flex-col">
            <label class="text-xs text-gray-600">Save route to favorites</label>
            <div class="flex flex-row">
              <input type="text"
              class="input-base mr-1"
              [(ngModel)] = "favoriteRouteName"
              placeholder="Favorite route name">
              <button (click)="saveRoute()" class="h-12 flex items-center px-4 cursor-pointer bg-app-accent rounded-full text-sm font-normal font-poppins text-neutral-900 hover:bg-lime-500 transition-colors">
                <span class="tracking-wide text-black flex-1 text-center">
                    Save
                </span>
              </button>
            </div>
          </div>

          <button (click)="bookRide()" class="w-full h-12 flex items-center px-4 cursor-pointer bg-app-accent rounded-full text-sm font-normal font-poppins text-neutral-900 hover:bg-lime-500 transition-colors">
            <span class="tracking-wide text-black flex-1 text-center">
                Book
            </span>
          </button>

          <button (click)="previousStep()" class="w-full cursor-pointer h-12 border-[1.5px] border-gray-300 rounded-full text-sm font-normal font-poppins text-gray-700 hover:bg-gray-50 transition-colors">
              Back
          </button>

        </div>
      }
        @if (isSuccessOpen()) {
        <div class="fixed inset-0 z-800 flex items-center justify-center">
          <!-- Backdrop -->
          <div class="absolute inset-0 bg-black/50"></div>

          <!-- Modal -->
          <div class="relative z-10 w-full max-w-sm bg-white rounded-2xl shadow-xl p-6">
            <div class="text-center space-y-4">
              <div class="flex justify-center">
                <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h2 class="text-lg font-semibold text-gray-900">Booking Successful!</h2>
              <p class="text-sm text-gray-600">
                {{successMessage}}
              </p>
              <button
                [routerLink]="dashboardUrl"
                class="mt-4 px-6 py-2 cursor-pointer rounded-full text-sm bg-app-accent text-app-dark hover:bg-app-accent-dark transition"
              >
                Exit
              </button>
            </div>
          </div>
        </div>
      }

      <error-alert
      [isOpen]="isErrorOpen()"
      [message]="errorMessage"
      [title]="errorTitle"
      (close)="closeErrorAlert()"> </error-alert>

      <success-alert
      [isOpen]="isSuccessAlertOpen()"
      [message]="successMessage"
      [title]="successAlertTitle"
      (close)="closeSuccessAlert()"> </success-alert>

  </div>
</div>
